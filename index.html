<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NASIS Calculation Validation Interpretation and Report Parser • cvirrr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="NASIS Calculation Validation Interpretation and Report Parser">
<meta property="og:description" content="Tools for evaluating Calculation Validation Interpretation Report (CVIR) scripts outside of the U.S. Department of Agriculture Natural Resources Conservation Service (USDA-NRCS) National Soil Information System (NASIS)">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">cvirrr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="cvirrr">cvirrr<a class="anchor" aria-label="anchor" href="#cvirrr"></a>
</h1></div>
<!-- badges: start -->
<p>The primary goal of {cvirrr} is to evaluate Calculation Validation Interpretation Report (CVIR) scripts outside of <a href="https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/tools/?cid=nrcs142p2_053554" class="external-link">National Soil Information System (NASIS)</a>. NASIS makes use of the <a href="https://www.antlr.org/" class="external-link">ANTLR</a> (ANother Tool for Language Recognition) parser generator to implement conversion of CVIR to SQL internally.</p>
<p>Methods in {cvirrr} handle lexing and parsing of CVIR outside of NASIS/ANTLR. Scripts are pre-processed, tokenized and parsed into an Abstract Syntax Tree. The Abstract Syntax Tree can then be evaluated as a combination of R code and SQL.</p>
<div class="section level2">
<h2 id="what-is-cvir">What is CVIR?<a class="anchor" aria-label="anchor" href="#what-is-cvir"></a>
</h2>
<p>CVIR is the scripting language for NASIS Calculations, Validations, Interpretations, and Reports. CVIR is used in the latest versions of NASIS and Web Soil Survey Rule and Report Manager.</p>
<p>The <a href="https://www.nrcs.usda.gov/Internet/FSE_DOCUMENTS/nrcs142p2_053305.pdf" class="external-link">NASIS CVIR Language Manual</a> provides details on CVIR syntax.</p>
<p>The language implements a mixture of syntax from SQL and Informix to facilitate doing calculations on data sources (generally queried from the database) and generating structured reports. The syntax is “familiar,” but unique, and NASIS is currently the only tool that can evaluate CVIR scripts.</p>
</div>
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>A significant amount of the business logic of the Soil and Plant Science Division is encoded in CVIR. While the NASIS interface is a powerful and unique platform for data analysis and managing CVIR scripts, there would be significant benefit to being able to derive information from and process CVIR scripts using R. For instance this would allow us to more readily re-use internal NASIS logic with external data sources, more readily conduct automated/batch analyses, and would provide opportunities for enhanced graphics and formatting.</p>
<p>There is an immediate interest in being able to evaluate CVIR from R in order to dynamically derive inputs for the new <a href="http://github.com/ncss-tech/interpretation-engine" class="external-link">ncss-tech/InterpretationEngine</a> package. {cvirrr} is intended to be lightweight and focused; implemented as a layer beneath the functionality planned to be provided by InterpretationEngine.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the latest version of {cvirrr} from GitHub using the {remotes} package</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("remotes")</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"brownag/cvirrr"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>For an example, we will load a CVIR script</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">cvirrr</span><span class="op">)</span>

<span class="va">cvir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"https://gist.githubusercontent.com/brownag/9e108e3b66251794556660dc1607d695/raw/47a5b916598bfc3ae62da566c0a3fbd5d20d901a/DustfromGypsumContent2to15Percent.cvir.sql"</span>, warn <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><code><a href="reference/cleanCVIR.html">cleanCVIR()</a></code> is how CVIR scripts are pre-processed to remove non-essential markup and get expressions on a single line.</p>
<div class="section level3">
<h3 id="before">Before<a class="anchor" aria-label="anchor" href="#before"></a>
</h3>
<p>Initially we have a CVIR script with comments, white space, and statements spanning multiple lines.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">cvir</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; base table component.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # Retrieves the weighted average gypsum the surface to 50cm or to a restrictive layer.  The weighted average gypsum is for that portion of each horizon in the depth range.</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; EXEC SQL select hzdept_r, hzdepb_r, gypsum_l, gypsum_r, gypsum_h</span>
<span class="co">#&gt;     from component,  chorizon</span>
<span class="co">#&gt;     where join component to chorizon and </span>
<span class="co">#&gt;     hzdepb_r &gt; hzdept_r;</span>
<span class="co">#&gt;     SORT BY hzdept_r</span>
<span class="co">#&gt;     AGGREGATE column  hzdept_r none, hzdepb_r none, gypsum_l none, gypsum_r none, gypsum_h none.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # Determine the depth to RESTRICTIVE LAYER.</span>
<span class="co">#&gt; # Determine the LAYER THICKNESS IN RANGE; ABOVE A RESTRICTIVE LAYER.</span>
<span class="co">#&gt; DERIVE  layer_thickness from  rv using "NSSC Data":"LAYER THICKNESS IN RANGE; ABOVE VSTR RESTRICT BELOW O" (0,50).</span>
<span class="co">#&gt; DERIVE depth from rv using "NSSC Data":"DEPTH TO FIRST STR/VSTR CEMENTED BELOW ORGANIC LAYER".</span>
<span class="co">#&gt; DERIVE o_thickness from rv using "NSSC Pangaea":"THICKNESS OF SURFACE ORGANIC HORIZON".</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; # Find minimum of restriction depth and 200cm </span>
<span class="co">#&gt; DEFINE min_depth  depth &lt; 250 and not isnull(depth) ? depth : 250.</span>
<span class="co">#&gt; DEFINE in_range   isnull (hzdepb_r) ? hzdepb_r :</span>
<span class="co">#&gt;        (hzdepb_r  - o_thickness &lt;= min_depth ? 1 : hzdepb_r - hzdept_r &gt;= min_depth ? 1 : 0).</span>
<span class="co">#&gt;        </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ASSIGN gypsum_l      isnull(gypsum_l) ? 0 : gypsum_l.</span>
<span class="co">#&gt; ASSIGN gypsum_r      isnull(gypsum_r) ? 0 : gypsum_r.</span>
<span class="co">#&gt; ASSIGN gypsum_h      isnull(gypsum_h) ? 0 : gypsum_h.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; DEFINE default 0*layer_thickness.</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; # Find the weighted average #10 sieve in the depth 0-100cm.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; define low       wtavg((if hzdepb_r - o_thickness &lt;=0 THEN default ELSE lookup(1, in_range, gypsum_l)), layer_thickness).</span>
<span class="co">#&gt; define rv        wtavg((if hzdepb_r - o_thickness &lt;=0 THEN default ELSE lookup(1, in_range, gypsum_r)), layer_thickness).</span>
<span class="co">#&gt; define high     wtavg((if hzdepb_r - o_thickness &lt;=0 THEN default ELSE lookup(1, in_range, gypsum_h)), layer_thickness).</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="after">After<a class="anchor" aria-label="anchor" href="#after"></a>
</h3>
<p>After “cleaning” we have the same script with comments removed, white space reduced and individual statements collapsed into single lines.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/cleanCVIR.html">cleanCVIR</a></span><span class="op">(</span><span class="va">cvir</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; base table component.</span>
<span class="co">#&gt; EXEC SQL select hzdept_r, hzdepb_r, gypsum_l, gypsum_r, gypsum_h from component, chorizon where join component to chorizon and hzdepb_r &gt; hzdept_r; SORT BY hzdept_r AGGREGATE column hzdept_r none, hzdepb_r none, gypsum_l none, gypsum_r none, gypsum_h none.</span>
<span class="co">#&gt; DERIVE layer_thickness from rv using "NSSC Data":"LAYER THICKNESS IN RANGE; ABOVE VSTR RESTRICT BELOW O" (0,50).</span>
<span class="co">#&gt; DERIVE depth from rv using "NSSC Data":"DEPTH TO FIRST STR/VSTR CEMENTED BELOW ORGANIC LAYER".</span>
<span class="co">#&gt; DERIVE o_thickness from rv using "NSSC Pangaea":"THICKNESS OF SURFACE ORGANIC HORIZON".</span>
<span class="co">#&gt; DEFINE min_depth depth &lt; 250 and not isnull(depth) ? depth : 250.</span>
<span class="co">#&gt; DEFINE in_range isnull (hzdepb_r) ? hzdepb_r : (hzdepb_r - o_thickness &lt;= min_depth ? 1 : hzdepb_r - hzdept_r &gt;= min_depth ? 1 : 0).</span>
<span class="co">#&gt; ASSIGN gypsum_l isnull(gypsum_l) ? 0 : gypsum_l.</span>
<span class="co">#&gt; ASSIGN gypsum_r isnull(gypsum_r) ? 0 : gypsum_r.</span>
<span class="co">#&gt; ASSIGN gypsum_h isnull(gypsum_h) ? 0 : gypsum_h.</span>
<span class="co">#&gt; DEFINE default 0*layer_thickness.</span>
<span class="co">#&gt; define low wtavg((if hzdepb_r - o_thickness &lt;=0 THEN default ELSE lookup(1, in_range, gypsum_l)), layer_thickness).</span>
<span class="co">#&gt; define rv wtavg((if hzdepb_r - o_thickness &lt;=0 THEN default ELSE lookup(1, in_range, gypsum_r)), layer_thickness).</span>
<span class="co">#&gt; define high wtavg((if hzdepb_r - o_thickness &lt;=0 THEN default ELSE lookup(1, in_range, gypsum_h)), layer_thickness).</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing cvirrr</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Andrew Brown <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/brownag/cvirrr/actions" class="external-link"><img src="https://github.com/brownag/cvirrr/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="http://humus.rocks/cvirrr/" class="external-link"><img src="https://img.shields.io/badge/docs-HTML-informational" alt="cvirrr Manual"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Andrew Brown.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
